services:
  controller:
    # NOTE: Hot-reload is opt-in because long-lived streaming connections (e.g. Sonos)
    # can make reload/shutdown hang and render the app unreachable.
    # Enable with: `ROOMCAST_RELOAD=1 make dev` or `ROOMCAST_RELOAD=1 make dev-detach`.
    command: >
      sh -lc 'uvicorn main:app --host 0.0.0.0 --port 8000 --proxy-headers --timeout-graceful-shutdown 2 ${ROOMCAST_RELOAD:+--reload}'
    volumes:
      - ./server:/app
      - ./server/static:/app/static:ro
      - config:/config
      - snapfifo:/tmp
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      PYTHONDONTWRITEBYTECODE: "1"
      RADIO_WORKER_TOKEN: ${RADIO_WORKER_TOKEN:-}
      # When running in Docker bridge mode, multicast discovery may fail and
      # the controller will fall back to scanning DISCOVERY_CIDR for devices (Sonos, node agents).
      # Not hardcoded: set at runtime, e.g. `DISCOVERY_CIDR=192.168.68.0/24 make dev`.
      DISCOVERY_CIDR: ${DISCOVERY_CIDR:-}

volumes:
  config:

