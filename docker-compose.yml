x-librespot-base: &librespot-base
  build: ./librespot
  network_mode: host
  entrypoint: []
  depends_on:
    - snapserver
  volumes:
    - snapfifo:/tmp
    - config:/config
  command: ["/app/run.sh"]

services:
  controller:
    build:
      context: .
      dockerfile: server/Dockerfile
    network_mode: host
    devices:
      - /dev/snd:/dev/snd
    group_add:
      - audio
    environment:
      SNAPSERVER_HOST: 127.0.0.1
      SNAPSERVER_PORT: 1780
      CONFIG_PATH: /config/spotify.json
      SPOTIFY_CLIENT_ID: ${SPOTIFY_CLIENT_ID:-}
      SPOTIFY_CLIENT_SECRET: ${SPOTIFY_CLIENT_SECRET:-}
      SPOTIFY_REDIRECT_URI: ${SPOTIFY_REDIRECT_URI:-http://localhost:8000/api/spotify/callback}
    depends_on:
      - snapserver
      - librespot_ch1
    volumes:
      - ./server/static:/app/static:ro
      - config:/config

  snapserver:
    image: saiyato/snapserver:latest
    network_mode: host
    command:
      - --stream.source
      - pipe:///tmp/snapfifo-ch1?name=Spotify_CH1&sampleformat=44100:16:2&codec=pcm
      - --stream.source
      - pipe:///tmp/snapfifo-ch2?name=Spotify_CH2&sampleformat=44100:16:2&codec=pcm
      - --http-cors
      - '*'
    volumes:
      - snapfifo:/tmp
      - ./snapserver.json:/root/.config/snapserver/server.json

  librespot_ch1:
    <<: *librespot-base
    environment:
      CONFIG_PATH: /config/spotify.json
      SPOTIFY_TOKEN_PATH: /config/spotify-token.json
      STATUS_PATH: /config/librespot-status.json
      FIFO_PATH: /tmp/snapfifo-ch1
      LIBRESPOT_FALLBACK_NAME: ${LIBRESPOT_NAME:-RoomCast}

  librespot_ch2:
    <<: *librespot-base
    environment:
      CONFIG_PATH: /config/spotify-ch2.json
      SPOTIFY_TOKEN_PATH: /config/spotify-token-ch2.json
      STATUS_PATH: /config/librespot-status-ch2.json
      FIFO_PATH: /tmp/snapfifo-ch2
      LIBRESPOT_FALLBACK_NAME: ${LIBRESPOT_NAME_CH2:-RoomCast CH2}

volumes:
  snapfifo:
  config:
