x-librespot-base: &librespot-base
  build: ./librespot
  entrypoint: []
  depends_on:
    - snapserver
  volumes:
    - snapfifo:/tmp
    - config:/config
  command: ["/app/run.sh"]

services:
  controller:
    build:
      context: .
      dockerfile: server/Dockerfile
    devices:
      - /dev/snd:/dev/snd
    group_add:
      - audio
    ports:
      # UI (and general API). Override via ROOMCAST_UI_PORT.
      - "${ROOMCAST_UI_PORT:-18080}:8000"
      # Sonos pulls audio from the controller; expose a dedicated host port for it.
      # Override via ROOMCAST_SONOS_PORT.
      - "${ROOMCAST_SONOS_PORT:-18081}:8000"
    environment:
      SNAPSERVER_HOST: snapserver
      SNAPSERVER_PORT: 1780
      ROOMCAST_PUBLIC_HOST: ${ROOMCAST_PUBLIC_HOST:-192.168.68.139}
      # Sonos will be given absolute stream URLs using this host port.
      ROOMCAST_PUBLIC_PORT: ${ROOMCAST_SONOS_PORT:-18081}
      CONFIG_PATH: /config/spotify.json
      SPOTIFY_CLIENT_ID: ${SPOTIFY_CLIENT_ID:-}
      SPOTIFY_CLIENT_SECRET: ${SPOTIFY_CLIENT_SECRET:-}
      # If you use Spotify auth, ensure the registered redirect URI matches this externally reachable URL.
      SPOTIFY_REDIRECT_URI: ${SPOTIFY_REDIRECT_URI:-http://localhost:${ROOMCAST_UI_PORT:-18080}/api/spotify/callback}
      RADIO_WORKER_TOKEN: ${RADIO_WORKER_TOKEN:-}
    depends_on:
      - snapserver
      - librespot_ch1
    volumes:
      - ./server/static:/app/static:ro
      - config:/config

  snapserver:
    build:
      context: ./snapserver
      args:
        SNAPCAST_VERSION: "0.31.0"
    ports:
      - "${SNAPSERVER_HTTP_PORT:-1780}:1780"
      - "${SNAPSERVER_STREAM_PORT:-1704}:1704"
    command:
      - --stream.source
      - pipe:///tmp/snapfifo-ch1?name=Spotify_CH1&sampleformat=44100:16:2&codec=pcm
      - --stream.source
      - pipe:///tmp/snapfifo-ch2?name=Spotify_CH2&sampleformat=44100:16:2&codec=pcm
      - --stream.source
      - pipe:///tmp/snapfifo-radio1?name=Radio_CH1&sampleformat=48000:16:2&codec=pcm
      - --stream.source
      - pipe:///tmp/snapfifo-radio2?name=Radio_CH2&sampleformat=48000:16:2&codec=pcm
      - --http-cors
      - '*'
    volumes:
      - snapfifo:/tmp
      - ./snapserver.json:/root/.config/snapserver/server.json

  librespot_ch1:
    <<: *librespot-base
    environment:
      CONFIG_PATH: /config/spotify.json
      SPOTIFY_TOKEN_PATH: /config/spotify-token.json
      STATUS_PATH: /config/librespot-status.json
      FIFO_PATH: /tmp/snapfifo-ch1
      LIBRESPOT_FALLBACK_NAME: ${LIBRESPOT_NAME:-RoomCast}

  librespot_ch2:
    <<: *librespot-base
    environment:
      CONFIG_PATH: /config/spotify-ch2.json
      SPOTIFY_TOKEN_PATH: /config/spotify-token-ch2.json
      STATUS_PATH: /config/librespot-status-ch2.json
      FIFO_PATH: /tmp/snapfifo-ch2
      LIBRESPOT_FALLBACK_NAME: ${LIBRESPOT_NAME_CH2:-RoomCast CH2}

  radio_worker:
    build: ./radio-worker
    depends_on:
      - controller
      - snapserver
    environment:
      CONTROLLER_BASE_URL: ${CONTROLLER_BASE_URL:-http://controller:8000}
      RADIO_WORKER_TOKEN: ${RADIO_WORKER_TOKEN:-}
      RADIO_ASSIGNMENT_INTERVAL: ${RADIO_ASSIGNMENT_INTERVAL:-10}
    volumes:
      - snapfifo:/tmp

volumes:
  snapfifo:
  config:
