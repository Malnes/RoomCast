services:
  controller:
    build: ./server
    network_mode: host
    environment:
      SNAPSERVER_HOST: 127.0.0.1
      SNAPSERVER_PORT: 1780
      CONFIG_PATH: /config/spotify.json
      SPOTIFY_CLIENT_ID: ${SPOTIFY_CLIENT_ID:-}
      SPOTIFY_CLIENT_SECRET: ${SPOTIFY_CLIENT_SECRET:-}
      SPOTIFY_REDIRECT_URI: ${SPOTIFY_REDIRECT_URI:-http://localhost:8000/api/spotify/callback}
    depends_on:
      - snapserver
      - librespot
    volumes:
      - ./server/static:/app/static:ro
      - config:/config

  snapserver:
    image: saiyato/snapserver:latest
    network_mode: host
    command:
      - --stream.source
      - pipe:///tmp/snapfifo?name=Spotify
      - --stream.sampleformat
      - 44100:16:2
      - --stream.codec
      - pcm
      - --http-cors
      - '*'
    volumes:
      - snapfifo:/tmp
      - ./snapserver.json:/root/.config/snapserver/server.json

  librespot:
    build: ./librespot
    network_mode: host
    entrypoint: []
    depends_on:
      - snapserver
    volumes:
      - snapfifo:/tmp
      - config:/config
    environment:
      LIBRESPOT_FALLBACK_NAME: ${LIBRESPOT_NAME:-RoomCast}
    command: ["/app/run.sh"]

volumes:
  snapfifo:
  config:
